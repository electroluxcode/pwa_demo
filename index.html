<head>
  <title>Electrolux demo</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" type="text/css" href="main.css">
  <link rel="icon" href="/e.png" type="image/png" />
</head>

<body>
  <div class="revision">测试</div>
  <img src="pwa-fonts.png">
  <div class="main-text">
    Electrolux demo 示例
  </div>
  <div class="network-message">
    Network:
    <span id="network-status" class="">Good</span>
    <button id="notifications" onclick="addToDesktop()">安装</button>
  </div>




  <script>
    //这里是进行sw.js 离线缓存的设置，注册service worker
    if (navigator.serviceWorker != null) {
      navigator.serviceWorker.register('sw.js')
        .then(function (registration) {
          console.log('Registered events at scope: ', registration.scope);
        });
    }

    fetch('./data.json')

    var statusEl = document.querySelector('#network-status')
    if (!navigator.onLine) {
      statusEl.classList = ['is-offline']
      statusEl.innerText = 'Offline'
    }
  </script>

  <script>

    //首先进行授权
    Notification.requestPermission().then(function (result) {
      if (result === 'granted') {
        console.log("已经授权")
      }
    });

    
    var deferredPrompt = null;

    // 监听beforeinstallprompt事件，该事件在网站满足PWA安装条件时触发，保存安装事件
    window.addEventListener("beforeinstallprompt", e => {
        e.preventDefault();
        deferredPrompt = e;
    });

    // 监听appinstalled事件，该事件在用户同意安装后触发，清空安装事件
    window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
    });

    // 手动触发PWA安装
    function addToDesktop() {
        deferredPrompt.prompt();
    }


    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later.
      deferredPrompt = e;
      window.download = function (acceptedCallbackFunction) {
        // Show the prompt
        deferredPrompt.prompt();
        // Wait for the user to respond to the prompt
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the A2HS prompt');
            if (acceptedCallbackFunction) {
              acceptedCallbackFunction();
            }
          } else {
            console.log('User dismissed the A2HS prompt');
          }
          deferredPrompt = null;
        });
      };
    })

  </script>
</body>